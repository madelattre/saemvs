---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# saemvs

`saemvs` implements high-dimensional variable selection for nonlinear mixed-effects models by coupling spike-and-slab priors with the Stochastic Approximation Expectation-Maximization (SAEM) algorithm.

## Installation

This package contains C++ code using **Rcpp** and **RcppArmadillo**, which requires a working C++ and Fortran toolchain. Please follow the instructions for your operating system:

### macOS

- R ≥ 4.1 is required.
- gfortran ≥ 14.x must be installed for compiling C++ code.  
  Download the official gfortran 14.x installer here:  
  [https://mac.r-project.org/tools/](https://mac.r-project.org/tools/)  
- Verify your installation:

```bash
gfortran --version
````

### Windows

`Rtools` must be installed for compiling packages with C++ and Fortran code.
Make sure to use the version of `Rtools` corresponding to your R version:
[https://cran.r-project.org/bin/windows/Rtools/](https://cran.r-project.org/bin/windows/Rtools/)

### Linux

Ensure gfortran and a C++ compiler are installed via your package manager.
Example for Debian/Ubuntu:

```bash
sudo apt update
sudo apt install gfortran build-essential
````

### Installation from GitHub

The package is not yet available on CRAN. The development version of **saemvs** can be installed directly from GitHub.

```{r}
# Install remotes if needed
install.packages("remotes")

# Install saemvs from GitHub
remotes::install_github("madelattre/saemvs")
```

## Example


Below is a minimal example illustrating the main workflow of the package.
For a complete and reproducible analysis, please refer to the package vignettes.

```{r, eval = FALSE}
library(saemvs)
data(df_long)
data(df_cov)


## Join the two dataframes and declaring the saemvsData object

full_data <- merge(df_long, df_cov, by = "id")

saemvs_input <- saemvsData_from_df(
  formula = as.formula("y ~ . + repeated(time) + group(id)"),
  data = full_data
)

# Define the model function
g <- function(t, a, b, c) {
  b + a / (1 + exp(-(t - c)))
}

# Create saemvsModel object
model <- saemvsModel(
  g = g,
  phi_to_select = c("a", "c")
)


# Define hyperparameters for the slab
hyper_slab <- saemvsHyperSlab(
  cov_re_prior_scale = diag(rep(0.2, 2)),
  cov_re_prior_df = 4
)


# Define tuning parameters
tuning <- saemvsTuning(
  niter = 1000,
  nburnin = 800,
  spike_values_grid = exp(-3 + seq(3, 10) * 3 / 4) 
)

# Define initial values
init_values <- saemvsInit(
  intercept = c(1300, 350, 400),
  beta_candidates = matrix(
    c(
      80, 20, 20, rep(0, 47), 
      rep(0, 50), 
      15, 0, 5, rep(0, 47)
    ),
    ncol = 3
  ),
  cov_re = diag(c(400, 200, 200)), 
  sigma2 = 100
)

# Run the SAEMVS algorithm
result <- saemvs(
  data = saemvs_input,
  model = model,
  init = init_values,
  tuning_algo = tuning,
  hyperparam = hyper_slab
)

summary(result)

plot(result, type = "criterion")
plot(result, type = "coefficients")[[1]]
plot(result, type = "coefficients")[[2]]
```